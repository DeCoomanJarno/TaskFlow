@if(selectedProjectId) {
  <div class="task-board">
    <div class="board-header">
      <div class="header-left">
        <h1 class="board-title">Tasks</h1>
        <div class="task-count">{{ displayTasks.length }} {{ displayTasks.length === 1 ? 'task' : 'tasks' }}</div>
      </div>
      
      <div class="header-actions">
        <button 
          mat-icon-button 
          class="view-toggle"
          (click)="cycleViewMode()"
          [matTooltip]="getViewTooltip()">
          <mat-icon>{{ getViewIcon() }}</mat-icon>
        </button>
        
        <button 
          mat-raised-button 
          color="primary" 
          class="add-task-btn"
          (click)="openCreateTask()">
          <mat-icon>add</mat-icon>
          <span>Add Task</span>
        </button>
      </div>
    </div>

    <div class="board-filters">
      <mat-form-field appearance="outline" class="filter-field">
        <mat-label>Search tasks</mat-label>
        <input
          matInput
          [(ngModel)]="filterText"
          (ngModelChange)="applyFilters()"
          placeholder="Filter by title or description">
        @if (filterText) {
          <button matSuffix mat-icon-button aria-label="Clear search" (click)="filterText = ''; applyFilters()">
            <mat-icon>close</mat-icon>
          </button>
        }
      </mat-form-field>

      <mat-form-field appearance="outline" class="filter-field">
        <mat-label>Assignee</mat-label>
        <mat-select [(ngModel)]="selectedUserId" (selectionChange)="applyFilters()">
          <mat-option [value]="null">All users</mat-option>
          @for (user of users; track user.id) {
            <mat-option [value]="user.id">{{ user.name }}</mat-option>
          }
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" class="filter-field">
        <mat-label>Sort by</mat-label>
        <mat-select [(ngModel)]="sortOption" (selectionChange)="applyFilters()">
          <mat-option value="order">Board order</mat-option>
          <mat-option value="priority">Priority (high to low)</mat-option>
          <mat-option value="title">Title (A to Z)</mat-option>
          <mat-option value="assignee">Assignee (A to Z)</mat-option>
        </mat-select>
      </mat-form-field>

      <button mat-stroked-button class="clear-filters" (click)="clearFilters()">
        <mat-icon>filter_alt_off</mat-icon>
        Clear
      </button>
    </div>

    <!-- Kanban View -->
    @if (viewMode === 'kanban') {
      <div class="kanban-board">
        @for (column of columns; track column.id) {
          <div class="kanban-column">
            <div class="column-header" [style.border-color]="column.color">
              <div class="column-title-row">
                <div class="column-icon" [style.background-color]="column.color">
                  <mat-icon>{{ column.icon }}</mat-icon>
                </div>
                <h3 class="column-title">{{ column.title }}</h3>
                <span class="column-count">{{ column.tasks.length }}</span>
              </div>
            </div>

            <div 
              class="column-content"
              cdkDropList
              [cdkDropListData]="column.tasks"
              [id]="column.id"
              [cdkDropListConnectedTo]="['new', 'in-progress', 'completed']"
              (cdkDropListDropped)="onTaskDrop($event, column)">
              
              @for (task of column.tasks; track task.id; let i = $index) {
                <div 
                  class="task-card-wrapper"
                  cdkDrag
                  [style.animation-delay]="i * 0.03 + 's'">
                  <mat-card class="task-card" [class]="getTaskStatusClass(task)" (click)="openTaskDetail(task)">
                    <div class="card-header">
                      <div class="task-priority" [class]="getPriorityColor(task.priority)">
                        <div class="priority-indicator"></div>
                        <span class="priority-label">{{ getPriorityLabel(task.priority) }}</span>
                      </div>
                      
                      <div class="card-actions">
                        <button mat-icon-button class="action-btn" (click)="editTask(task, $event)">
                          <mat-icon>edit</mat-icon>
                        </button>
                        <button
                          mat-icon-button
                          class="action-btn delete"
                          (click)="deleteTask(task, $event)"
                          [disabled]="!canDeleteTasks()"
                          matTooltip="Log in to delete tasks"
                          [matTooltipDisabled]="canDeleteTasks()">
                          <mat-icon>delete</mat-icon>
                        </button>
                      </div>
                    </div>

                    <mat-card-content class="card-content">
                      <h3 class="task-title">{{ task.title }}</h3>
                      
                      @if (task.description) {
                        <p class="task-description">{{ task.description }}</p>
                      }
                      
                      <div class="task-meta">
                        @if (task.assignedUserId) {
                          <div class="meta-item">
                            <mat-icon>person</mat-icon>
                            <span>{{ task.assignedUserName }}</span>
                          </div>
                        }
                        
                        @if (task.completedDate) {
                          <div class="meta-item">
                            <mat-icon>event</mat-icon>
                            <span>{{ task.completedDate | date: 'MMM d' }}</span>
                          </div>
                        }
                      </div>
                    </mat-card-content>
                  </mat-card>
                </div>
              }

              @if (column.tasks.length === 0) {
                <div class="column-empty">
                  <mat-icon>{{ column.icon }}</mat-icon>
                  <p>No tasks</p>
                </div>
              }
            </div>
          </div>
        }
      </div>
    }

    <!-- Grid View -->
    @if (viewMode === 'grid') {
      <div class="tasks-container grid-view">
        @for (task of displayTasks; track task.id; let i = $index) {
          <div 
            class="task-card-wrapper"
            [style.animation-delay]="i * 0.05 + 's'">
            <mat-card class="task-card" [class]="getTaskStatusClass(task)" (click)="openTaskDetail(task)">
              <div class="card-header">
                <div class="task-priority" [class]="getPriorityColor(task.priority)">
                  <div class="priority-indicator"></div>
                  <span class="priority-label">{{ getPriorityLabel(task.priority) }}</span>
                </div>
                
                <div class="card-actions">
                  <button mat-icon-button class="action-btn" (click)="editTask(task, $event)">
                    <mat-icon>edit</mat-icon>
                  </button>
                  <button
                    mat-icon-button
                    class="action-btn delete"
                    (click)="deleteTask(task, $event)"
                    [disabled]="!canDeleteTasks()"
                    matTooltip="Log in to delete tasks"
                    [matTooltipDisabled]="canDeleteTasks()">
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>
              </div>

              <mat-card-content class="card-content">
                <div class="task-status-badge" [class]="getTaskStatusClass(task)">
                  @if (getTaskStatus(task) === 'new') {
                    <mat-icon>fiber_new</mat-icon>
                    <span>New</span>
                  }
                  @if (getTaskStatus(task) === 'in-progress') {
                    <mat-icon>sync</mat-icon>
                    <span>In Progress</span>
                  }
                  @if (getTaskStatus(task) === 'completed') {
                    <mat-icon>check_circle</mat-icon>
                    <span>Completed</span>
                  }
                </div>

                <h3 class="task-title">{{ task.title }}</h3>
                
                @if (task.description) {
                  <p class="task-description">{{ task.description }}</p>
                }
                
                <div class="task-meta">
                  @if (task.assignedUserId) {
                    <div class="meta-item">
                      <mat-icon>person</mat-icon>
                      <span>{{ task.assignedUserName }}</span>
                    </div>
                  }
                  
                  @if (task.completedDate) {
                    <div class="meta-item">
                      <mat-icon>event</mat-icon>
                      <span>{{ task.completedDate | date: 'MMM d, y' }}</span>
                    </div>
                  }
                </div>

              </mat-card-content>
            </mat-card>
          </div>
        }
        
        @if (displayTasks.length === 0) {
          <div class="empty-state">
            <div class="empty-icon">
              <mat-icon>task_alt</mat-icon>
            </div>
            <h2>No tasks yet</h2>
            <p>Create your first task to get started</p>
            <button 
              mat-raised-button 
              color="primary" 
              class="empty-action-btn"
              (click)="openCreateTask()">
              <mat-icon>add</mat-icon>
              <span>Create Task</span>
            </button>
          </div>
        }
      </div>
    }

    <!-- List View -->
    @if (viewMode === 'list') {
      <div class="tasks-container list-view">
        @for (task of displayTasks; track task.id; let i = $index) {
          <div 
            class="task-card-wrapper"
            [style.animation-delay]="i * 0.03 + 's'">
            <mat-card class="task-card list-card" [class]="getTaskStatusClass(task)" (click)="openTaskDetail(task)">
              <mat-card-content class="list-card-content">
                <div class="list-main">
                  <div class="task-status-badge" [class]="getTaskStatusClass(task)">
                    @if (getTaskStatus(task) === 'new') {
                      <mat-icon>fiber_new</mat-icon>
                      <span>New</span>
                    }
                    @if (getTaskStatus(task) === 'in-progress') {
                      <mat-icon>sync</mat-icon>
                      <span>In Progress</span>
                    }
                    @if (getTaskStatus(task) === 'completed') {
                      <mat-icon>check_circle</mat-icon>
                      <span>Completed</span>
                    }
                  </div>

                  <div class="list-info">
                    <h3 class="task-title">{{ task.title }}</h3>
                    @if (task.description) {
                      <p class="task-description">{{ task.description }}</p>
                    }
                  </div>

                  <div class="list-meta">
                    <div class="task-priority" [class]="getPriorityColor(task.priority)">
                      <div class="priority-indicator"></div>
                      <span class="priority-label">{{ getPriorityLabel(task.priority) }}</span>
                    </div>

                    @if (task.assignedUserId) {
                      <div class="meta-item">
                        <mat-icon>person</mat-icon>
                        <span>{{ task.assignedUserName }}</span>
                      </div>
                    }
                    
                    @if (task.completedDate) {
                      <div class="meta-item">
                        <mat-icon>event</mat-icon>
                        <span>{{ task.completedDate | date: 'MMM d, y' }}</span>
                      </div>
                    }
                  </div>

                </div>

                <div class="list-actions">
                  <button mat-icon-button class="action-btn" (click)="editTask(task, $event)">
                    <mat-icon>edit</mat-icon>
                  </button>
                  <button
                    mat-icon-button
                    class="action-btn delete"
                    (click)="deleteTask(task, $event)"
                    [disabled]="!canDeleteTasks()"
                    matTooltip="Log in to delete tasks"
                    [matTooltipDisabled]="canDeleteTasks()">
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>
              </mat-card-content>
            </mat-card>
          </div>
        }
        
        @if (displayTasks.length === 0) {
          <div class="empty-state">
            <div class="empty-icon">
              <mat-icon>task_alt</mat-icon>
            </div>
            <h2>No tasks yet</h2>
            <p>Create your first task to get started</p>
            <button 
              mat-raised-button 
              color="primary" 
              class="empty-action-btn"
              (click)="openCreateTask()">
              <mat-icon>add</mat-icon>
              <span>Create Task</span>
            </button>
          </div>
        }
      </div>
    }
  </div>
} @else {
  <div class="select-project-state">
    <div class="state-content">
      <div class="state-icon">
        <mat-icon>folder_open</mat-icon>
      </div>
      <h2>Select a category</h2>
      <p>Choose a category from the sidebar to view and manage tasks</p>
    </div>
  </div>
}
